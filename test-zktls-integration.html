<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zkTLS Integration Test - Rhythm Pose</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #8A2BE2;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #8A2BE2;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #8A2BE2;
        }
        
        .btn {
            background: #8A2BE2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #7B68EE;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .proof-display {
            background: #f1f3f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .proof-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .proof-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .proof-title {
            font-weight: bold;
            color: #8A2BE2;
        }
        
        .proof-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” zkTLS Integration Test</h1>
            <p>æµ‹è¯• Rhythm Pose çš„ zkTLS é›†æˆåŠŸèƒ½</p>
        </div>

        <div class="grid">
            <!-- å·¦ä¾§ï¼šæµ‹è¯•æ§åˆ¶ -->
            <div>
                <!-- åˆå§‹åŒ–æµ‹è¯• -->
                <div class="test-section">
                    <h3>1. åˆå§‹åŒ–æµ‹è¯•</h3>
                    <button id="test-init" class="btn">åˆå§‹åŒ– zkTLS</button>
                    <button id="test-wallet" class="btn">è¿æ¥é’±åŒ…</button>
                    <div id="init-status" class="status info">ç­‰å¾…åˆå§‹åŒ–...</div>
                </div>

                <!-- é…ç½®æµ‹è¯• -->
                <div class="test-section">
                    <h3>2. é…ç½®æµ‹è¯•</h3>
                    <div class="form-group">
                        <label>ç”¨æˆ·åœ°å€:</label>
                        <input type="text" id="user-address" placeholder="0x..." readonly>
                    </div>
                    <div class="form-group">
                        <label>æ¨¡æ¿ID:</label>
                        <input type="text" id="template-id" value="rhythm_pose_achievement">
                    </div>
                    <button id="test-config" class="btn">éªŒè¯é…ç½®</button>
                    <div id="config-status" class="status info">ç­‰å¾…é…ç½®éªŒè¯...</div>
                </div>

                <!-- è¯æ˜ç”Ÿæˆæµ‹è¯• -->
                <div class="test-section">
                    <h3>3. è¯æ˜ç”Ÿæˆæµ‹è¯•</h3>
                    <div class="form-group">
                        <label>å§¿æ€åç§°:</label>
                        <select id="pose-name">
                            <option value="tree-pose">æ ‘å¼</option>
                            <option value="warrior-pose">æˆ˜å£«å¼</option>
                            <option value="diamond-hands">Diamond Hands</option>
                            <option value="thumbs-up">ç‚¹èµ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¾—åˆ† (0-100):</label>
                        <input type="number" id="test-score" value="85" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>æŒç»­æ—¶é—´ (ç§’):</label>
                        <input type="number" id="test-duration" value="5" min="1" max="60">
                    </div>
                    <div class="form-group">
                        <label>å‡†ç¡®åº¦ (0-100):</label>
                        <input type="number" id="test-accuracy" value="90" min="0" max="100">
                    </div>
                    <button id="test-generate" class="btn" disabled>ç”Ÿæˆè¯æ˜</button>
                    <div id="generate-status" class="status info">ç­‰å¾…ç”Ÿæˆè¯æ˜...</div>
                </div>

                <!-- éªŒè¯æµ‹è¯• -->
                <div class="test-section">
                    <h3>4. éªŒè¯æµ‹è¯•</h3>
                    <button id="test-verify" class="btn" disabled>éªŒè¯æœ€æ–°è¯æ˜</button>
                    <button id="test-export" class="btn" disabled>å¯¼å‡ºè¯æ˜æ•°æ®</button>
                    <div id="verify-status" class="status info">ç­‰å¾…éªŒè¯...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœæ˜¾ç¤º -->
            <div>
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div class="test-section">
                    <h3>ç³»ç»ŸçŠ¶æ€</h3>
                    <div id="system-status">
                        <p><strong>zkTLSçŠ¶æ€:</strong> <span id="zktls-status">æœªåˆå§‹åŒ–</span></p>
                        <p><strong>é’±åŒ…çŠ¶æ€:</strong> <span id="wallet-status">æœªè¿æ¥</span></p>
                        <p><strong>è¯æ˜æ•°é‡:</strong> <span id="proof-count">0</span></p>
                        <p><strong>æœ€åæ“ä½œ:</strong> <span id="last-operation">æ— </span></p>
                    </div>
                </div>

                <!-- è¯æ˜æ˜¾ç¤º -->
                <div class="test-section">
                    <h3>è¯æ˜å†å²</h3>
                    <div id="proof-display" class="proof-display">
                        <p>æš‚æ— è¯æ˜</p>
                    </div>
                </div>

                <!-- æ—¥å¿—æ˜¾ç¤º -->
                <div class="test-section">
                    <h3>æ“ä½œæ—¥å¿—</h3>
                    <div id="log-area" class="log-area">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="js/zktls-browser-wrapper.js"></script>
    <script src="js/zktls-config.js"></script>
    <script src="js/zktls-integration.js"></script>
    <script src="js/zktls-scoring-integration.js"></script>

    <script>
        // æµ‹è¯•åº”ç”¨ç±»
        class ZKTLSTestApp {
            constructor() {
                this.zkTLSIntegration = null;
                this.zkTLSScoringIntegration = null;
                this.mockScoringSystem = {
                    achievements: [],
                    newAchievements: [],
                    getScoreData: () => ({
                        currentScore: parseInt(document.getElementById('test-score').value),
                        duration: parseInt(document.getElementById('test-duration').value),
                        accuracy: parseInt(document.getElementById('test-accuracy').value),
                        stability: 85,
                        level: 5,
                        combo: 3,
                        totalScore: 1250
                    })
                };
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.log('æµ‹è¯•åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            }

            setupEventListeners() {
                document.getElementById('test-init').addEventListener('click', () => this.testInitialization());
                document.getElementById('test-wallet').addEventListener('click', () => this.testWalletConnection());
                document.getElementById('test-config').addEventListener('click', () => this.testConfiguration());
                document.getElementById('test-generate').addEventListener('click', () => this.testProofGeneration());
                document.getElementById('test-verify').addEventListener('click', () => this.testProofVerification());
                document.getElementById('test-export').addEventListener('click', () => this.testExportProofs());
            }

            async testInitialization() {
                try {
                    this.log('å¼€å§‹åˆå§‹åŒ– zkTLS...');
                    this.updateStatus('init-status', 'æ­£åœ¨åˆå§‹åŒ–...', 'info');

                    this.zkTLSIntegration = new ZKTLSIntegration();
                    await this.zkTLSIntegration.initialize();

                    this.zkTLSScoringIntegration = new ZKTLSScoringIntegration(
                        this.mockScoringSystem,
                        this.zkTLSIntegration
                    );

                    this.updateStatus('init-status', 'zkTLS åˆå§‹åŒ–æˆåŠŸ', 'success');
                    this.updateSystemStatus();
                    this.log('âœ… zkTLS åˆå§‹åŒ–æˆåŠŸ');

                    document.getElementById('test-generate').disabled = false;
                } catch (error) {
                    this.updateStatus('init-status', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    this.log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                }
            }

            async testWalletConnection() {
                try {
                    this.log('å¼€å§‹è¿æ¥é’±åŒ…...');
                    
                    if (typeof window.ethereum !== 'undefined') {
                        const accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        
                        if (accounts.length > 0) {
                            const userAddress = accounts[0];
                            document.getElementById('user-address').value = userAddress;
                            
                            if (this.zkTLSIntegration) {
                                this.zkTLSIntegration.setUserAddress(userAddress);
                            }
                            
                            this.updateSystemStatus();
                            this.log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸ: ${userAddress}`);
                        }
                    } else {
                        throw new Error('æœªæ£€æµ‹åˆ° MetaMask');
                    }
                } catch (error) {
                    this.log(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`);
                }
            }

            testConfiguration() {
                try {
                    this.log('éªŒè¯é…ç½®...');
                    
                    const validation = ZKTLSConfig.validate();
                    if (validation.isValid) {
                        this.updateStatus('config-status', 'é…ç½®éªŒè¯æˆåŠŸ', 'success');
                        this.log('âœ… é…ç½®éªŒè¯æˆåŠŸ');
                    } else {
                        this.updateStatus('config-status', `é…ç½®é”™è¯¯: ${validation.errors.join(', ')}`, 'error');
                        this.log(`âŒ é…ç½®é”™è¯¯: ${validation.errors.join(', ')}`);
                    }
                } catch (error) {
                    this.updateStatus('config-status', `é…ç½®éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                    this.log(`âŒ é…ç½®éªŒè¯å¤±è´¥: ${error.message}`);
                }
            }

            async testProofGeneration() {
                try {
                    this.log('å¼€å§‹ç”Ÿæˆè¯æ˜...');
                    this.updateStatus('generate-status', 'æ­£åœ¨ç”Ÿæˆè¯æ˜...', 'info');

                    const poseName = document.getElementById('pose-name').value;
                    const scoreData = this.mockScoringSystem.getScoreData();

                    const proof = await this.zkTLSScoringIntegration.generatePoseProof(poseName, scoreData);

                    this.updateStatus('generate-status', 'è¯æ˜ç”ŸæˆæˆåŠŸ', 'success');
                    this.updateProofDisplay();
                    this.updateSystemStatus();
                    this.log(`âœ… è¯æ˜ç”ŸæˆæˆåŠŸ: ${proof.id}`);

                    document.getElementById('test-verify').disabled = false;
                    document.getElementById('test-export').disabled = false;
                } catch (error) {
                    this.updateStatus('generate-status', `è¯æ˜ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                    this.log(`âŒ è¯æ˜ç”Ÿæˆå¤±è´¥: ${error.message}`);
                }
            }

            async testProofVerification() {
                try {
                    this.log('å¼€å§‹éªŒè¯è¯æ˜...');
                    
                    const latestProof = this.zkTLSIntegration.getLatestProof();
                    if (!latestProof) {
                        throw new Error('æ²¡æœ‰å¯éªŒè¯çš„è¯æ˜');
                    }

                    const isValid = await this.zkTLSIntegration.verifyProof(latestProof.attestation);
                    
                    if (isValid) {
                        this.updateStatus('verify-status', 'è¯æ˜éªŒè¯æˆåŠŸ', 'success');
                        this.log(`âœ… è¯æ˜éªŒè¯æˆåŠŸ: ${latestProof.id}`);
                    } else {
                        this.updateStatus('verify-status', 'è¯æ˜éªŒè¯å¤±è´¥', 'error');
                        this.log(`âŒ è¯æ˜éªŒè¯å¤±è´¥: ${latestProof.id}`);
                    }
                } catch (error) {
                    this.updateStatus('verify-status', `éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                    this.log(`âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`);
                }
            }

            testExportProofs() {
                try {
                    this.log('å¯¼å‡ºè¯æ˜æ•°æ®...');
                    
                    const proofData = this.zkTLSIntegration.exportProofData();
                    const dataStr = JSON.stringify(proofData, null, 2);
                    
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `zktls-test-proofs-${Date.now()}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    this.log('âœ… è¯æ˜æ•°æ®å¯¼å‡ºæˆåŠŸ');
                } catch (error) {
                    this.log(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`);
                }
            }

            updateStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.className = `status ${type}`;
                }
            }

            updateSystemStatus() {
                if (this.zkTLSIntegration) {
                    const status = this.zkTLSIntegration.getStatus();
                    document.getElementById('zktls-status').textContent = status.isInitialized ? 'å·²å°±ç»ª' : 'æœªåˆå§‹åŒ–';
                    document.getElementById('wallet-status').textContent = status.userAddress ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                    document.getElementById('proof-count').textContent = status.proofCount;
                }
                document.getElementById('last-operation').textContent = new Date().toLocaleTimeString();
            }

            updateProofDisplay() {
                if (!this.zkTLSIntegration) return;

                const proofHistory = this.zkTLSIntegration.getProofHistory();
                const displayElement = document.getElementById('proof-display');

                if (proofHistory.length > 0) {
                    displayElement.innerHTML = proofHistory
                        .slice(-3)
                        .reverse()
                        .map(proof => {
                            const formatted = this.zkTLSIntegration.formatProofForDisplay(proof);
                            return `
                                <div class="proof-item">
                                    <div class="proof-header">
                                        <span class="proof-title">${formatted.poseName}</span>
                                        <span class="proof-status">${formatted.verified}</span>
                                    </div>
                                    <div>å¾—åˆ†: ${formatted.score} | æ—¶é•¿: ${formatted.duration}s</div>
                                    <div>æ—¶é—´: ${formatted.timestamp}</div>
                                </div>
                            `;
                        })
                        .join('');
                } else {
                    displayElement.innerHTML = '<p>æš‚æ— è¯æ˜</p>';
                }
            }

            log(message) {
                const logArea = document.getElementById('log-area');
                const timestamp = new Date().toLocaleTimeString();
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
                console.log(message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æµ‹è¯•åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.testApp = new ZKTLSTestApp();
        });
    </script>
</body>
</html>
